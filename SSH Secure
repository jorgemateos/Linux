#!/bin/bash

# Archivo de log
LOG_FILE="ssh-security.log"
echo "ğŸš€ Inicio de la securizaciÃ³n de SSH" > $LOG_FILE
echo "Fecha: $(date)" >> $LOG_FILE

# Solicitar puerto SSH
read -p "ğŸ”¢ Ingresa el puerto SSH (recomendado > 1024): " SSH_PORT

# Solicitar clave pÃºblica SSH
read -p "ğŸ”‘ Pega tu clave pÃºblica SSH (RSA, ed25519, etc.): " SSH_KEY

# Verificar entrada de clave pÃºblica
if [[ -z "$SSH_KEY" ]]; then
    echo "âš ï¸ No se ingresÃ³ una clave pÃºblica. Abortando..." | tee -a $LOG_FILE
    exit 1
fi

echo "ğŸš€ Iniciando instalaciÃ³n y securizaciÃ³n de SSH en Ubuntu..." | tee -a $LOG_FILE

# 1ï¸âƒ£ Actualizar sistema
echo "ğŸ”„ Actualizando paquetes..." | tee -a $LOG_FILE
sudo apt update && sudo apt upgrade -y

# 2ï¸âƒ£ Instalar OpenSSH Server si no estÃ¡ instalado
echo "ğŸ”‘ Instalando OpenSSH Server..." | tee -a $LOG_FILE
sudo apt install -y openssh-server

# 3ï¸âƒ£ Configurar SSH
echo "ğŸ›  Configurando SSH en el puerto $SSH_PORT..." | tee -a $LOG_FILE

# Modificar el archivo de configuraciÃ³n
sudo sed -i "s/^#Port 22/Port $SSH_PORT/g" /etc/ssh/sshd_config
sudo sed -i "s/^PermitRootLogin yes/PermitRootLogin no/g" /etc/ssh/sshd_config
sudo sed -i "s/^#PermitRootLogin prohibit-password/PermitRootLogin no/g" /etc/ssh/sshd_config
sudo sed -i "s/^PasswordAuthentication yes/PasswordAuthentication no/g" /etc/ssh/sshd_config
sudo sed -i "s/^#PasswordAuthentication no/PasswordAuthentication no/g" /etc/ssh/sshd_config

# 4ï¸âƒ£ Agregar clave pÃºblica SSH al usuario actual
echo "ğŸ”‘ Agregando clave pÃºblica SSH..." | tee -a $LOG_FILE
mkdir -p ~/.ssh
echo "$SSH_KEY" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh

# Aplicar cambios y reiniciar SSH
echo "ğŸ”„ Reiniciando SSH..." | tee -a $LOG_FILE
sudo systemctl restart ssh

# 5ï¸âƒ£ Verificar si el Firewall UFW estÃ¡ instalado
if ! command -v ufw &> /dev/null
then
    echo "ğŸ”¥ UFW no estÃ¡ instalado. InstalÃ¡ndolo ahora..." | tee -a $LOG_FILE
    sudo apt install -y ufw
fi

# 6ï¸âƒ£ Configurar Firewall (UFW)
echo "ğŸ”¥ Configurando Firewall (UFW) para permitir SSH en el puerto $SSH_PORT..." | tee -a $LOG_FILE
sudo ufw allow $SSH_PORT/tcp
sudo ufw enable -y

# 7ï¸âƒ£ Instalar y configurar Fail2Ban
echo "ğŸ›¡ Instalando Fail2Ban..." | tee -a $LOG_FILE
sudo apt install -y fail2ban

# Configurar Fail2Ban para SSH
echo "ğŸ“‘ Configurando reglas de Fail2Ban..." | tee -a $LOG_FILE
sudo bash -c 'cat > /etc/fail2ban/jail.local <<EOL
[sshd]
enabled = true
port = '$SSH_PORT'
maxretry = 5
bantime = 3600
EOL'

# Reiniciar Fail2Ban
sudo systemctl restart fail2ban
sudo systemctl enable fail2ban

# 8ï¸âƒ£ Generar archivo de log con verificaciones finales
echo "ğŸ“ Generando informe de seguridad en $LOG_FILE..." | tee -a $LOG_FILE
{
    echo "âœ… VerificaciÃ³n final de seguridad:"
    echo "-----------------------------------"
    echo "ğŸ“Œ Fecha: $(date)"
    echo "ğŸ” SSH ahora usa el puerto: $SSH_PORT"
    echo "âš ï¸ La autenticaciÃ³n por contraseÃ±a estÃ¡ deshabilitada."
    echo "ğŸ”‘ Clave pÃºblica SSH agregada correctamente."
    echo "ğŸ”¥ Firewall UFW estÃ¡ habilitado y permite el puerto $SSH_PORT."
    echo "ğŸ›¡ Fail2Ban activado para proteger el acceso SSH."
    echo "-----------------------------------"
    echo "ğŸ” Verificando estado del servicio SSH:"
    sudo systemctl status ssh | grep Active
    echo "ğŸ” Verificando puertos abiertos en SSH:"
    sudo ss -tulnp | grep ssh
    echo "ğŸ” Verificando reglas del firewall UFW:"
    sudo ufw status verbose
    echo "ğŸ” Verificando estado de Fail2Ban:"
    sudo fail2ban-client status sshd
} >> $LOG_FILE

# 9ï¸âƒ£ Mostrar resumen final
echo "âœ… ConfiguraciÃ³n finalizada." | tee -a $LOG_FILE
echo "ğŸ” SSH ahora usa el puerto: $SSH_PORT" | tee -a $LOG_FILE
echo "âš ï¸ La autenticaciÃ³n por contraseÃ±a estÃ¡ deshabilitada." | tee -a $LOG_FILE
echo "ğŸ”‘ Clave pÃºblica SSH agregada correctamente." | tee -a $LOG_FILE
echo "ğŸ”¥ Firewall UFW estÃ¡ habilitado y permite el puerto $SSH_PORT." | tee -a $LOG_FILE
echo "ğŸ›¡ Fail2Ban activado para proteger el acceso SSH." | tee -a $LOG_FILE
echo "ğŸ“„ Informe de seguridad guardado en: $LOG_FILE" | tee -a $LOG_FILE
